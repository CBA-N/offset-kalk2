{% extends "base.html" %}

{% block title %}Kalkulator Druku - Strona Główna{% endblock %}

{% block content %}
<div class="main-container">
    <div class="text-center mb-4">
        <h1><i class="fas fa-print text-primary"></i> Kalkulator Druku Offsetowego</h1>
        <p class="lead text-muted">Automatyczna kalkulacja z optymalizacją formatu arkusza</p>
    </div>

    <form id="kalkulatorForm">
        <!-- Sekcja 1: Dane podstawowe -->
        <div class="card">
            <div class="card-header">
                <i class="fas fa-info-circle"></i> Dane Podstawowe
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Nazwa produktu</label>
                        <input type="text" class="form-control" name="nazwa_produktu" value="Mój wydruk" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Nakład (szt)</label>
                        <input type="number" class="form-control" name="naklad" value="1000" min="1" required>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-12 mb-3">
                        <label class="form-label">
                            <i class="fas fa-tag"></i> Rodzaj pracy (opcjonalnie - wypełni wymiary)
                        </label>
                        <select class="form-select" id="rodzajPracy">
                            <option value="">-- Wybierz gotowy szablon lub wpisz wymiary ręcznie --</option>
                            {% for nazwa, dane in rodzaje_prac.items() %}
                            <option value="{{ nazwa }}" data-w="{{ dane.szerokosc }}" data-h="{{ dane.wysokosc }}">
                                {{ nazwa }} ({{ dane.szerokosc }}×{{ dane.wysokosc }} mm) - {{ dane.opis }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Szerokość (mm)</label>
                        <input type="number" class="form-control" name="format_szerokosc" value="210" min="10" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Wysokość (mm)</label>
                        <input type="number" class="form-control" name="format_wysokosc" value="297" min="10" required>
                    </div>
                </div>
                
                <div class="d-flex gap-2 flex-wrap">
                    <button type="button" class="btn btn-sm btn-outline-secondary format-btn" data-w="90" data-h="50">Wizytówka (90×50)</button>
                    <button type="button" class="btn btn-sm btn-outline-secondary format-btn" data-w="210" data-h="297">A4 (210×297)</button>
                    <button type="button" class="btn btn-sm btn-outline-secondary format-btn" data-w="148" data-h="210">A5 (148×210)</button>
                    <button type="button" class="btn btn-sm btn-outline-secondary format-btn" data-w="420" data-h="594">A2 (420×594)</button>
                    <button type="button" class="btn btn-sm btn-outline-secondary format-btn" data-w="100" data-h="150">Etykieta (100×150)</button>
                </div>
            </div>
        </div>

        <!-- Sekcja 2: Kontrahent -->
        <div class="card">
            <div class="card-header bg-info text-white">
                <i class="fas fa-building"></i> Kontrahent (opcjonalnie)
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-8 mb-3">
                        <label class="form-label">Wybierz kontrahenta</label>
                        <select class="form-select" id="kontrahent_id" name="kontrahent_id">
                            <option value="">-- Bez kontrahenta --</option>
                        </select>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label">&nbsp;</label>
                        <a href="/kontrahenci" class="btn btn-success w-100" target="_blank">
                            <i class="fas fa-plus"></i> Zarządzaj kontrahentami
                        </a>
                    </div>
                </div>
                
                <!-- Podgląd wybranego kontrahenta -->
                <div id="kontrahentPodglad" class="alert alert-info" style="display: none;">
                    <h6><i class="fas fa-user-tie"></i> Wybrany kontrahent:</h6>
                    <div id="kontrahentDane"></div>
                </div>
            </div>
        </div>

        <!-- Sekcja 3: Materiał -->
        <div class="card">
            <div class="card-header">
                <i class="fas fa-file"></i> Materiał
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3 mb-3">
                        <label class="form-label">1. Kategoria papieru</label>
                        <select class="form-select" id="kategoriaPapieru" required>
                            <option value="">-- Wybierz kategorię --</option>
                        </select>
                    </div>
                    <div class="col-md-3 mb-3">
                        <label class="form-label">2. Rodzaj papieru</label>
                        <select class="form-select" name="rodzaj_papieru" id="rodzajPapieru" required disabled>
                            <option value="">-- Najpierw wybierz kategorię --</option>
                        </select>
                    </div>
                    <div class="col-md-3 mb-3">
                        <label class="form-label">3. Gramatura (g/m²)</label>
                        <select class="form-select" name="gramatura" id="gramatura" required disabled>
                            <option value="">-- Wybierz papier --</option>
                        </select>
                    </div>
                    <div class="col-md-3 mb-3">
                        <label class="form-label">Kolorystyka</label>
                        <select class="form-select" name="kolorystyka" id="kolorystyka" required>
                            {% for kod, dane in kolorystyki.items() %}
                            <option value="{{ kod }}">{{ dane.etykieta if dane.etykieta else kod }}</option>
                            {% endfor %}
                        </select>
                        <small class="text-muted d-block mt-1" id="kolorystykaOpis"></small>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-3 mb-3">
                        <label class="form-label">Ilość form drukowych</label>
                        <input type="number" class="form-control" name="ilosc_form" id="iloscForm"
                               value="4" min="1" max="16" required>
                        <div class="form-check mt-2 d-none" id="odwracankaWrapper">
                            <input class="form-check-input" type="checkbox" id="odwracankaCheckbox">
                            <label class="form-check-label" for="odwracankaCheckbox">
                                Odwracanka
                                <small class="text-muted d-block">Wykorzystaj druk odwracany, aby zmniejszyć liczbę form o połowę.</small>
                            </label>
                        </div>
                    </div>
                </div>
                
                <!-- Cięcie papieru z B1 -->
                <div class="row">
                    <div class="col-md-12">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="wymagaCiecia" 
                                   name="wymaga_ciecia_papieru" checked>
                            <label class="form-check-label" for="wymagaCiecia">
                                <i class="fas fa-cut"></i> Papier wymaga cięcia z arkuszy B1 (700×1000mm)
                                <small class="text-muted d-block">Odznacz jeśli papier jest już docięty do formatu drukarskiego</small>
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sekcja 4: Kolory specjalne -->
        <div class="card">
            <div class="card-header">
                <i class="fas fa-palette"></i> Kolory Specjalne (opcjonalnie)
            </div>
            <div class="card-body">
                <div id="kolorySpecjalne">
                    {% for nazwa in kolory_spec.keys() %}
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="kolory_specjalne" value="{{ nazwa }}" id="kolor_{{ loop.index }}">
                        <label class="form-check-label" for="kolor_{{ loop.index }}">
                            {{ nazwa }} <span class="badge bg-info">{{ kolory_spec[nazwa]['koszt_za_kolor'] }} PLN</span>
                        </label>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Sekcja 5: Uszlachetnienia -->
        <div class="card">
            <div class="card-header">
                <i class="fas fa-star"></i> Uszlachetnienia (opcjonalnie)
            </div>
            <div class="card-body">
                <div id="uszlachetnienia" class="row">
                    {% for nazwa in uszlachetnienia.keys() %}
                    <div class="col-md-6">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="uszlachetnienia" value="{{ nazwa }}" id="uszlach_{{ loop.index }}">
                            <label class="form-check-label" for="uszlach_{{ loop.index }}">
                                {{ nazwa }}
                            </label>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Sekcja 6: Obróbka -->
        <div class="card">
            <div class="card-header">
                <i class="fas fa-cut"></i> Obróbka Wykończeniowa (opcjonalnie)
            </div>
            <div class="card-body">
                <div id="obrobka" class="row">
                    {% for nazwa in obrobka.keys() %}
                    <div class="col-md-6">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="obrobka" value="{{ nazwa }}" id="obrobka_{{ loop.index }}">
                            <label class="form-check-label" for="obrobka_{{ loop.index }}">
                                {{ nazwa }}
                            </label>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Sekcja 7: Pakowanie i transport -->
        <div class="card">
            <div class="card-header">
                <i class="fas fa-box"></i> Pakowanie i Transport
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Pakowanie</label>
                        <select class="form-select" name="pakowanie">
                            {% for nazwa in pakowanie.keys() %}
                            <option value="{{ nazwa }}">{{ nazwa }} ({{ pakowanie[nazwa]['cena'] }} PLN)</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Transport</label>
                        <select class="form-select" name="transport">
                            {% for nazwa in transport.keys() %}
                            <option value="{{ nazwa }}">{{ nazwa }} ({{ transport[nazwa]['cena'] }} PLN)</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sekcja 8: Marża i optymalizacja -->
        <div class="card">
            <div class="card-header">
                <i class="fas fa-cog"></i> Konfiguracja Wyceny
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Marża (%)</label>
                        <input type="number" class="form-control" name="marza_procent" value="20" min="0" max="100" step="0.1" required>
                        <div class="d-flex gap-2 mt-2 flex-wrap">
                            <button type="button" class="btn btn-sm btn-outline-secondary marza-btn" data-value="10">10%</button>
                            <button type="button" class="btn btn-sm btn-outline-secondary marza-btn" data-value="20">20%</button>
                            <button type="button" class="btn btn-sm btn-outline-secondary marza-btn" data-value="30">30%</button>
                            <button type="button" class="btn btn-sm btn-outline-secondary marza-btn" data-value="35">35%</button>
                        </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Priorytet optymalizacji</label>
                        <select class="form-select" name="priorytet_optymalizacji">
                            {% for nazwa in priorytety.keys() %}
                            <option value="{{ nazwa }}">{{ nazwa }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- Przycisk kalkulacji -->
        <div class="d-flex justify-content-center flex-wrap gap-2">
            <button type="submit" class="btn btn-primary btn-lg">
                <i class="fas fa-calculator"></i> Oblicz Cenę
            </button>
            <button type="button" class="btn btn-outline-secondary btn-lg" id="clearOfferBtn">
                <i class="fas fa-eraser"></i> Wyczyść ofertę
            </button>
        </div>
    </form>

    <!-- Loading Spinner -->
    <div class="loading-spinner" id="loadingSpinner">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Ładowanie...</span>
        </div>
        <p class="mt-2">Kalkuluję ofertę...</p>
    </div>

    <!-- Wyniki -->
    <div class="result-box" id="wyniki"></div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const kolorystykiSlownik = {{ kolorystyki | tojson }};

$(document).ready(function() {
    const FORM_CACHE_KEY = 'kalkulatorFormCache';
    const PAPER_CACHE_KEY = 'kalkulatorPapierCache';
    const PAPER_SELECTION_KEY = 'kalkulatorPapierSelection';
    const PAPER_CACHE_TTL_MS = 1000 * 60 * 60; // 1 godzina

    let odwracankaBazowaLiczbaForm = null;
    let programmaticFormChange = false;
    let blokujAutoCache = false;
    let papieryData = {};
    let gramaturyCache = {};
    let aktualneKategorie = [];
    let papieryPromise = null;
    let oczekujacyPapierDoPrzywrocenia = null;
    let przywracaniePapieruTrwa = false;
    let oczekujacyKontrahentId = null;

    const zapamietanyPapierPrzyStarcie = odczytajWyborPapieruZCache();
    if (zapamietanyPapierPrzyStarcie) {
        oczekujacyPapierDoPrzywrocenia = { ...zapamietanyPapierPrzyStarcie };
    }

    function pobierzDomyslnaIloscForm(definicja) {
        if (!definicja) return 1;

        let wartosc = parseInt(definicja.domyslna_ilosc_form, 10);
        if (!wartosc || wartosc <= 0) {
            let licznik = 0;
            const front = parseInt(definicja.kolory_przod, 10);
            const tyl = parseInt(definicja.kolory_tyl, 10);
            if (!isNaN(front) && front > 0) licznik += 1;
            if (!isNaN(tyl) && tyl > 0) licznik += 1;
            wartosc = licznik > 0 ? licznik : 1;
        }
        return wartosc;
    }

    function aktualizujOdwracankaVisibility() {
        const $wrapper = $('#odwracankaWrapper');
        const $checkbox = $('#odwracankaCheckbox');
        const value = parseInt($('#iloscForm').val(), 10);

        if ($checkbox.is(':checked')) {
            $wrapper.removeClass('d-none');
            return;
        }

        if (!isNaN(value) && value > 0 && value % 2 === 0) {
            $wrapper.removeClass('d-none');
            odwracankaBazowaLiczbaForm = value;
        } else {
            $wrapper.addClass('d-none');
            $checkbox.prop('checked', false);
            odwracankaBazowaLiczbaForm = null;
        }
    }

    function ustawIloscForm(value, aktualizujCache = true) {
        const wartosc = parseInt(value, 10);
        if (isNaN(wartosc) || wartosc <= 0) return;

        const $input = $('#iloscForm');
        programmaticFormChange = true;
        $input.val(wartosc);
        programmaticFormChange = false;
        aktualizujOdwracankaVisibility();

        if (aktualizujCache && !blokujAutoCache && typeof zapiszFormularzDoCache === 'function') {
            zapiszFormularzDoCache();
        }
    }

    function aktualizujKolorystykeUI(ustawDomyslneFormy = true) {
        const kod = $('#kolorystyka').val();
        const definicja = kolorystykiSlownik ? kolorystykiSlownik[kod] : null;
        const $opis = $('#kolorystykaOpis');

        if (!definicja) {
            $opis.text('');
            if (ustawDomyslneFormy) {
                $('#odwracankaCheckbox').prop('checked', false);
                odwracankaBazowaLiczbaForm = null;
                ustawIloscForm(4, false);
            } else {
                aktualizujOdwracankaVisibility();
            }
            return;
        }

        const opisCzesci = [];
        if (definicja.opis) {
            opisCzesci.push(definicja.opis);
        }
        if (definicja.kolory_przod !== undefined && definicja.kolory_tyl !== undefined) {
            opisCzesci.push(`Kolory: ${definicja.kolory_przod} / ${definicja.kolory_tyl}`);
        }
        if (definicja.domyslna_ilosc_form) {
            opisCzesci.push(`Sugerowane formy: ${definicja.domyslna_ilosc_form}`);
        }

        $opis.text(opisCzesci.filter(Boolean).join(' • '));

        if (ustawDomyslneFormy) {
            $('#odwracankaCheckbox').prop('checked', false);
            odwracankaBazowaLiczbaForm = null;
            const domyslne = pobierzDomyslnaIloscForm(definicja);
            ustawIloscForm(domyslne);
        } else {
            aktualizujOdwracankaVisibility();
        }
    }

    $('#kolorystyka').on('change', function() {
        aktualizujKolorystykeUI(true);
    });

    $('#iloscForm').on('input change', function() {
        if (programmaticFormChange) return;

        const value = parseInt($(this).val(), 10);
        if (!$('#odwracankaCheckbox').is(':checked')) {
            if (!isNaN(value) && value > 0 && value % 2 === 0) {
                odwracankaBazowaLiczbaForm = value;
            } else {
                odwracankaBazowaLiczbaForm = null;
            }
        }
        aktualizujOdwracankaVisibility();
    });

    $('#odwracankaCheckbox').on('change', function() {
        const $input = $('#iloscForm');
        if ($(this).is(':checked')) {
            if (!odwracankaBazowaLiczbaForm) {
                const current = parseInt($input.val(), 10);
                if (isNaN(current) || current <= 0 || current % 2 !== 0) {
                    $(this).prop('checked', false);
                    return;
                }
                odwracankaBazowaLiczbaForm = current;
            }

            const nowa = Math.max(1, Math.round(odwracankaBazowaLiczbaForm / 2));
            ustawIloscForm(nowa);
        } else {
            const bazowa = odwracankaBazowaLiczbaForm;
            odwracankaBazowaLiczbaForm = null;
            if (bazowa) {
                ustawIloscForm(bazowa);
            } else {
                aktualizujOdwracankaVisibility();
            }
        }
    });

    aktualizujKolorystykeUI(true);

    const defaultFormState = {
        nazwa_produktu: $('[name="nazwa_produktu"]').val(),
        naklad: $('[name="naklad"]').val(),
        format_szerokosc: $('[name="format_szerokosc"]').val(),
        format_wysokosc: $('[name="format_wysokosc"]').val(),
        rodzaj_pracy: $('#rodzajPracy').val() || '',
        kategoria_papieru: $('#kategoriaPapieru').val() || '',
        rodzaj_papieru: $('#rodzajPapieru').val() || '',
        gramatura: $('#gramatura').val() || '',
        kolorystyka: $('#kolorystyka').val(),
        ilosc_form: $('#iloscForm').val(),
        pakowanie: $('[name="pakowanie"]').val(),
        transport: $('[name="transport"]').val(),
        marza_procent: $('[name="marza_procent"]').val(),
        priorytet_optymalizacji: $('[name="priorytet_optymalizacji"]').val(),
        wymaga_ciecia_papieru: $('#wymagaCiecia').is(':checked'),
        kontrahent_id: $('#kontrahent_id').val() || ''
    };

    // === ŁADOWANIE KONTRAHENTÓW ===
    function ustawKontrahentaZCache(kontrahentId) {
        const $select = $('#kontrahent_id');
        if (!$select.length) {
            oczekujacyKontrahentId = (kontrahentId !== undefined && kontrahentId !== null && kontrahentId !== '')
                ? String(kontrahentId)
                : null;
            return false;
        }

        const normalizedId = (kontrahentId !== undefined && kontrahentId !== null && kontrahentId !== '')
            ? String(kontrahentId)
            : '';

        if (!normalizedId) {
            if ($select.val() !== '') {
                $select.val('');
            }
            $select.trigger('change');
            oczekujacyKontrahentId = null;
            return true;
        }

        const optionExists = $select.find('option').filter(function() {
            return $(this).val() === normalizedId;
        }).length > 0;

        if (optionExists) {
            if ($select.val() !== normalizedId) {
                $select.val(normalizedId);
            }
            $select.trigger('change');
            oczekujacyKontrahentId = null;
            return true;
        }

        oczekujacyKontrahentId = normalizedId;
        return false;
    }

    function zaladujKontrahentow() {
        $.get('/api/kontrahenci', function(response) {
            const $select = $('#kontrahent_id');
            const previousValue = $select.val();
            $select.html('<option value="">-- Bez kontrahenta --</option>');

            if (response.success && response.kontrahenci) {
                response.kontrahenci.forEach(function(k) {
                    $select.append(`<option value="${k.id}">${k.nazwa} (${k.nip || 'brak NIP'})</option>`);
                });
            }

            const docelowyKontrahent = (oczekujacyKontrahentId !== null && oczekujacyKontrahentId !== undefined)
                ? oczekujacyKontrahentId
                : previousValue;

            if (docelowyKontrahent !== undefined && docelowyKontrahent !== null && docelowyKontrahent !== '') {
                const ustawiono = ustawKontrahentaZCache(docelowyKontrahent);
                if (!ustawiono) {
                    $('#kontrahentPodglad').hide();
                }
            } else {
                if ($select.val() !== '') {
                    $select.val('');
                }
                $('#kontrahentPodglad').hide();
                oczekujacyKontrahentId = null;
            }
        }).fail(function() {
            console.error('Błąd ładowania kontrahentów');
        });
    }
    
    zaladujKontrahentow();
    
    // === PODGLĄD KONTRAHENTA ===
    $('#kontrahent_id').change(function() {
        const kontrahentId = $(this).val();

        oczekujacyKontrahentId = kontrahentId ? String(kontrahentId) : null;

        if (!kontrahentId) {
            $('#kontrahentPodglad').hide();
            return;
        }
        
        $.get('/api/kontrahenci/' + kontrahentId, function(response) {
            if (!response.success || !response.kontrahent) return;
            const k = response.kontrahent;
            let html = `
                <p class="mb-1"><strong>Nazwa:</strong> ${k.nazwa}</p>
                ${k.nip ? `<p class="mb-1"><strong>NIP:</strong> ${k.nip}</p>` : ''}
                ${k.adres && k.adres.miasto ? `<p class="mb-1"><strong>Miasto:</strong> ${k.adres.miasto}</p>` : ''}
                ${k.email ? `<p class="mb-1"><strong>Email:</strong> ${k.email}</p>` : ''}
                ${k.telefon ? `<p class="mb-0"><strong>Telefon:</strong> ${k.telefon}</p>` : ''}
            `;
            $('#kontrahentDane').html(html);
            $('#kontrahentPodglad').slideDown();
        });
    });
    
    // === FUNKCJA DUPLIKOWANIA - Wypełnij formularz z parametrów URL ===
    const urlParams = new URLSearchParams(window.location.search);
    
    if (urlParams.has('duplikat_z')) {
        const duplikatId = urlParams.get('duplikat_z');

        blokujAutoCache = true;

        // Wypełnij pola formularza
        if (urlParams.has('nazwa_produktu')) {
            $('#nazwaProduktu').val(urlParams.get('nazwa_produktu'));
        }
        
        if (urlParams.has('format_szerokosc') && urlParams.has('format_wysokosc')) {
            $('input[name="format_szerokosc"]').val(urlParams.get('format_szerokosc'));
            $('input[name="format_wysokosc"]').val(urlParams.get('format_wysokosc'));
        }
        
        if (urlParams.has('naklad')) {
            $('#naklad').val(urlParams.get('naklad'));
        }
        
        // Obsługa wyboru papieru z URL (dla duplikowania)
        if (urlParams.has('rodzaj_papieru')) {
            const rodzajPapieru = urlParams.get('rodzaj_papieru');
            const gramaturaValue = urlParams.get('gramatura');

            papieryPromise.then(() => {
                let znalezionaKategoria = null;

                Object.keys(papieryData || {}).some(function(kat) {
                    const lista = papieryData[kat] || [];
                    const znaleziono = lista.some(p => p.nazwa === rodzajPapieru);
                    if (znaleziono) {
                        znalezionaKategoria = kat;
                        return true;
                    }
                    return false;
                });

                if (!znalezionaKategoria) {
                    return;
                }

                $('#kategoriaPapieru').val(znalezionaKategoria);
                const ustawionoPapier = wypelnijRodzajePapieru(znalezionaKategoria, rodzajPapieru);

                if (ustawionoPapier) {
                    pobierzGramatury(rodzajPapieru, gramaturaValue);
                }
            });
        }

        if (urlParams.has('kolorystyka')) {
            $('#kolorystyka').val(urlParams.get('kolorystyka'));
            aktualizujKolorystykeUI(false);
        }

        // Listy (kolory specjalne, uszlachetnienia, obróbka)
        if (urlParams.has('kolory_specjalne')) {
            try {
                const kolory = JSON.parse(urlParams.get('kolory_specjalne'));
                kolory.forEach(kolor => {
                    $('#kolorySpecjalne option[value="' + kolor + '"]').prop('selected', true);
                });
            } catch (e) {}
        }
        
        if (urlParams.has('uszlachetnienia')) {
            try {
                const uszl = JSON.parse(urlParams.get('uszlachetnienia'));
                uszl.forEach(u => {
                    $('#uszlachetnienia option[value="' + u + '"]').prop('selected', true);
                });
            } catch (e) {}
        }
        
        if (urlParams.has('obrobka')) {
            try {
                const obrobka = JSON.parse(urlParams.get('obrobka'));
                obrobka.forEach(o => {
                    $('#obrobka option[value="' + o + '"]').prop('selected', true);
                });
            } catch (e) {}
        }
        
        if (urlParams.has('pakowanie')) {
            $('#pakowanie').val(urlParams.get('pakowanie'));
        }
        
        if (urlParams.has('transport')) {
            $('#transport').val(urlParams.get('transport'));
        }
        
        if (urlParams.has('marza_procent')) {
            $('#marzaProcent').val(urlParams.get('marza_procent'));
        }
        
        if (urlParams.has('priorytet_optymalizacji')) {
            $('#priorytetOptymalizacji').val(urlParams.get('priorytet_optymalizacji'));
        }
        
        // Kontrahent
        if (urlParams.has('kontrahent_id')) {
            setTimeout(() => {
                $('#kontrahent_id').val(urlParams.get('kontrahent_id')).trigger('change');
            }, 300);
        }
        
        // Pokaż komunikat
        setTimeout(() => {
            const alertHtml = `
                <div class="alert alert-success alert-dismissible fade show" role="alert">
                    <i class="fas fa-copy"></i> <strong>Załadowano dane z oferty #${duplikatId}</strong> —
                    Możesz teraz edytować parametry i wygenerować nową ofertę.
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            $('#kalkulatorForm').prepend(alertHtml);
        }, 300);

        blokujAutoCache = false;
    }
    
    
    // Szybkie przyciski formatu
    $('.format-btn').click(function() {
        $('input[name="format_szerokosc"]').val($(this).data('w'));
        $('input[name="format_wysokosc"]').val($(this).data('h'));

        if (!blokujAutoCache) {
            zapiszFormularzDoCache();
        }
    });
    
    // Dropdown rodzaju pracy - autofill wymiarów
    $('#rodzajPracy').change(function() {
        const selected = $(this).find(':selected');
        const w = selected.data('w');
        const h = selected.data('h');
        
        if (w && h) {
            $('input[name="format_szerokosc"]').val(w);
            $('input[name="format_wysokosc"]').val(h);
            
            // Opcjonalnie: zaktualizuj nazwę produktu
            const rodzajNazwa = selected.val();
            if (rodzajNazwa && $('input[name="nazwa_produktu"]').val() === 'Mój wydruk') {
                $('input[name="nazwa_produktu"]').val(rodzajNazwa);
            }
        }
    });
    
    // Szybkie przyciski marży
    $('.marza-btn').click(function() {
        $('input[name="marza_procent"]').val($(this).data('value'));

        if (!blokujAutoCache) {
            zapiszFormularzDoCache();
        }
    });
    
    // === KASKADOWY WYBÓR PAPIERÓW (3 KROKI) ===
    function resetRodzajPapieruSelect() {
        $('#rodzajPapieru')
            .html('<option value="">-- Najpierw wybierz kategorię --</option>')
            .prop('disabled', true);
    }

    async function przywrocPapierZFormularza(kategoria, rodzaj, gramatura) {
        const wybranaKategoria = kategoria || '';
        const wybranyRodzaj = rodzaj || '';
        const wybranaGramatura = (gramatura !== undefined && gramatura !== null && gramatura !== '')
            ? String(gramatura)
            : '';

        if (!wybranaKategoria) {
            $('#kategoriaPapieru').val('');
            resetRodzajPapieruSelect();
            resetGramaturaSelect();
            return true;
        }

        if (!papieryData || !papieryData[wybranaKategoria]) {
            return false;
        }

        $('#kategoriaPapieru').val(wybranaKategoria);
        const ustawionoRodzaj = wypelnijRodzajePapieru(wybranaKategoria, wybranyRodzaj);

        if (wybranyRodzaj) {
            if (!ustawionoRodzaj) {
                return false;
            }
            await pobierzGramatury(wybranyRodzaj, wybranaGramatura || null);
        } else {
            resetGramaturaSelect();
        }

        if (wybranaGramatura) {
            $('#gramatura').val(wybranaGramatura);
        }

        zapiszWyborPapieruDoCache({
            kategoria: $('#kategoriaPapieru').val() || '',
            rodzaj: $('#rodzajPapieru').val() || '',
            gramatura: $('#gramatura').val() || ''
        });

        return true;
    }

    async function sprobujPrzywrocicPapierJesliOczekuje() {
        if (!oczekujacyPapierDoPrzywrocenia || przywracaniePapieruTrwa) {
            return;
        }

        przywracaniePapieruTrwa = true;
        try {
            const dane = { ...oczekujacyPapierDoPrzywrocenia };
            const udalo = await przywrocPapierZFormularza(dane.kategoria, dane.rodzaj, dane.gramatura);
            if (udalo) {
                oczekujacyPapierDoPrzywrocenia = null;
            }
        } finally {
            przywracaniePapieruTrwa = false;
        }
    }

    function resetGramaturaSelect() {
        $('#gramatura')
            .html('<option value="">-- Wybierz papier --</option>')
            .prop('disabled', true);
    }

    function ustawGramaturaOptions(dataset, selected = null) {
        const $gramatura = $('#gramatura');
        const gramatury = Array.isArray(dataset?.gramatury) ? dataset.gramatury : [];
        const ceny = dataset?.ceny || {};

        if (!gramatury.length) {
            resetGramaturaSelect();
            return;
        }

        const selectedStr = selected !== null && selected !== undefined ? String(selected) : null;
        $gramatura.html('');
        gramatury.forEach(function(g) {
            const key = String(g);
            const cena = ceny[key] !== undefined ? Number(ceny[key]).toFixed(2) : '0.00';
            $gramatura.append(`<option value="${key}">${g} g/m² (${cena} PLN/kg)</option>`);
        });
        $gramatura.prop('disabled', false);

        if (selectedStr && gramatury.map(String).includes(selectedStr)) {
            $gramatura.val(selectedStr);
        }
    }

    function zapiszPapierCache(dataset = null) {
        try {
            const payload = {
                timestamp: Date.now(),
                kategorie: dataset?.kategorie || aktualneKategorie || [],
                papiery: dataset?.papiery || papieryData || {},
                gramatury: dataset?.gramatury || gramaturyCache || {}
            };
            localStorage.setItem(PAPER_CACHE_KEY, JSON.stringify(payload));
        } catch (e) {
            console.warn('Nie udało się zapisać cache papierów:', e);
        }
    }

    function zapiszWyborPapieruDoCache(stan = null) {
        const dane = stan || {
            kategoria: $('#kategoriaPapieru').val() || '',
            rodzaj: $('#rodzajPapieru').val() || '',
            gramatura: $('#gramatura').val() || ''
        };

        try {
            localStorage.setItem(PAPER_SELECTION_KEY, JSON.stringify(dane));
        } catch (e) {
            console.warn('Nie udało się zapisać wyboru papieru:', e);
        }
    }

    function odczytajWyborPapieruZCache() {
        try {
            const raw = localStorage.getItem(PAPER_SELECTION_KEY);
            if (!raw) return null;
            const parsed = JSON.parse(raw);
            if (!parsed || typeof parsed !== 'object') return null;
            return {
                kategoria: parsed.kategoria || '',
                rodzaj: parsed.rodzaj || '',
                gramatura: parsed.gramatura || ''
            };
        } catch (e) {
            console.warn('Nie udało się odczytać wyboru papieru:', e);
            return null;
        }
    }

    function wyczyscWyborPapieruCache() {
        try {
            localStorage.removeItem(PAPER_SELECTION_KEY);
        } catch (e) {
            console.warn('Nie udało się wyczyścić wyboru papieru:', e);
        }
    }

    function odczytajPapierCache() {
        try {
            const raw = localStorage.getItem(PAPER_CACHE_KEY);
            if (!raw) return null;
            const parsed = JSON.parse(raw);
            if (parsed.timestamp && Date.now() - parsed.timestamp > PAPER_CACHE_TTL_MS) {
                localStorage.removeItem(PAPER_CACHE_KEY);
                return null;
            }
            return parsed;
        } catch (e) {
            console.warn('Nie udało się odczytać cache papierów:', e);
            return null;
        }
    }

    function wypelnijKategorieSelect(kategorie) {
        const $kategoria = $('#kategoriaPapieru');
        const poprzedniaKategoria = $kategoria.val();
        const poprzedniRodzaj = $('#rodzajPapieru').val();
        const poprzedniaGramatura = $('#gramatura').val();

        aktualneKategorie = Array.isArray(kategorie) ? [...kategorie] : [];

        $kategoria.html('<option value="">-- Wybierz kategorię --</option>');
        aktualneKategorie.forEach(function(kat) {
            $kategoria.append(`<option value="${kat}">${kat}</option>`);
        });

        if (poprzedniaKategoria && aktualneKategorie.includes(poprzedniaKategoria)) {
            $kategoria.val(poprzedniaKategoria);
            const zachowano = wypelnijRodzajePapieru(poprzedniaKategoria, poprzedniRodzaj);
            if (zachowano && poprzedniRodzaj) {
                pobierzGramatury(poprzedniRodzaj, poprzedniaGramatura);
            }
        } else {
            $kategoria.val('');
            resetRodzajPapieruSelect();
            resetGramaturaSelect();
        }
    }

    function wypelnijRodzajePapieru(kategoria, wybrany = null) {
        resetRodzajPapieruSelect();
        resetGramaturaSelect();

        if (!kategoria || !papieryData || !papieryData[kategoria]) {
            return false;
        }

        const $rodzaj = $('#rodzajPapieru');
        const lista = papieryData[kategoria];
        $rodzaj.html('<option value="">-- Wybierz papier --</option>');
        lista.forEach(function(papier) {
            $rodzaj.append(`<option value="${papier.nazwa}">${papier.nazwa}</option>`);
        });
        $rodzaj.prop('disabled', false);

        if (wybrany && lista.some(p => p.nazwa === wybrany)) {
            $rodzaj.val(wybrany);
            return true;
        }

        return false;
    }

    function pobierzGramatury(rodzaj, selected = null) {
        if (!rodzaj) {
            resetGramaturaSelect();
            return Promise.resolve();
        }

        if (gramaturyCache[rodzaj]) {
            ustawGramaturaOptions(gramaturyCache[rodzaj], selected);
            return Promise.resolve();
        }

        return new Promise((resolve) => {
            $.get('/api/gramatury/' + encodeURIComponent(rodzaj), function(data) {
                gramaturyCache[rodzaj] = data;
                ustawGramaturaOptions(data, selected);
                zapiszPapierCache();
                resolve();
            }).fail(function() {
                console.error('Błąd ładowania gramatur');
                resolve();
            });
        });
    }

    function zaladujKategoriePapierow() {
        const cached = odczytajPapierCache();

        if (cached) {
            aktualneKategorie = Array.isArray(cached.kategorie) ? cached.kategorie : [];
            papieryData = cached.papiery || {};
            gramaturyCache = cached.gramatury || {};
            if (aktualneKategorie.length) {
                wypelnijKategorieSelect(aktualneKategorie);
            } else {
                resetRodzajPapieruSelect();
                resetGramaturaSelect();
            }
            sprobujPrzywrocicPapierJesliOczekuje();
        }

        return new Promise((resolve) => {
            $.get('/api/papiery-kategorie', function(data) {
                papieryData = data.papiery || {};
                aktualneKategorie = data.kategorie || [];
                wypelnijKategorieSelect(aktualneKategorie);
                sprobujPrzywrocicPapierJesliOczekuje();
                zapiszPapierCache({
                    kategorie: aktualneKategorie,
                    papiery: papieryData,
                    gramatury: gramaturyCache
                });
                if (!cached) {
                    resolve();
                }
            }).fail(function() {
                console.error('Błąd ładowania kategorii papierów');
                if (!cached) {
                    resolve();
                }
            });

            if (cached) {
                resolve();
            }
        });
    }

    papieryPromise = zaladujKategoriePapierow();

    $('#kategoriaPapieru').change(function() {
        const kategoria = $(this).val();
        wypelnijRodzajePapieru(kategoria);
        zapiszWyborPapieruDoCache();
    });

    $('#rodzajPapieru').change(function() {
        const rodzaj = $(this).val();
        pobierzGramatury(rodzaj).then(() => {
            zapiszWyborPapieruDoCache();
        });
    });

    $('#gramatura').change(function() {
        zapiszWyborPapieruDoCache();
    });
    
    // Obsługa formularza
    $('#kalkulatorForm').submit(function(e) {
        e.preventDefault();
        
        // Pokaż spinner
        $('#loadingSpinner').show();
        $('#wyniki').hide();
        
        // Zbierz dane
        const formData = {};
        $(this).serializeArray().forEach(function(item) {
            if (formData[item.name]) {
                if (Array.isArray(formData[item.name])) {
                    formData[item.name].push(item.value);
                } else {
                    formData[item.name] = [formData[item.name], item.value];
                }
            } else {
                formData[item.name] = item.value;
            }
        });
        
        // Checkboxy jako tablice
        formData.kolory_specjalne = [];
        $('input[name="kolory_specjalne"]:checked').each(function() {
            formData.kolory_specjalne.push($(this).val());
        });
        
        formData.uszlachetnienia = [];
        $('input[name="uszlachetnienia"]:checked').each(function() {
            formData.uszlachetnienia.push($(this).val());
        });
        
        formData.obrobka = [];
        $('input[name="obrobka"]:checked').each(function() {
            formData.obrobka.push($(this).val());
        });
        
        // Kontrahent - konwertuj na int lub null
        const kontrahentId = $('#kontrahent_id').val();
        formData.kontrahent_id = kontrahentId ? parseInt(kontrahentId) : null;
        
        // Cięcie papieru z B1
        formData.wymaga_ciecia_papieru = $('#wymagaCiecia').is(':checked');
        
        // Wyślij zapytanie
        $.ajax({
            url: '/api/kalkuluj',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(formData),
            success: function(response) {
                if (response.success) {
                    wyswietlWynik(response.wynik);
                } else {
                    alert('Błąd: ' + response.error);
                }
                $('#loadingSpinner').hide();
            },
            error: function(xhr) {
                alert('Błąd kalkulacji: ' + (xhr.responseJSON?.error || 'Nieznany błąd'));
                $('#loadingSpinner').hide();
            }
        });
    });
    
    function wyswietlWynik(wynik) {
        const format = wynik.wybrany_format;

        let html = `
            <h3 class="text-center mb-4"><i class="fas fa-check-circle text-success"></i> Oferta Wyceny</h3>
            
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="stat-card">
                        <h3><i class="fas fa-receipt"></i></h3>
                        <h3>${wynik.cena_brutto_vat23.toFixed(2)} PLN</h3>
                        <p>Cena brutto (VAT 23%)</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card">
                        <h3><i class="fas fa-file-alt"></i></h3>
                        <h3>${format.format_name}</h3>
                        <p>Wybrany format arkusza</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card">
                        <h3><i class="fas fa-layer-group"></i></h3>
                        <h3>${format.uzytki_na_ark}</h3>
                        <p>Użytków na arkuszu</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card">
                        <h3><i class="fas fa-percent"></i></h3>
                        <h3>${format.wykorzystanie_procent.toFixed(1)}%</h3>
                        <p>Wykorzystanie materiału</p>
                    </div>
                </div>
            </div>
            
            <div class="row mt-3">
                <div class="col-md-4 offset-md-4">
                    <div class="stat-card">
                        <h3><i class="fas fa-copy"></i></h3>
                        <h3>${format.ilosc_arkuszy}</h3>
                        <p>Ilość arkuszy</p>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">Szczegóły Kalkulacji</div>
                <div class="card-body">
                    <table class="table">
                        <tr>
                            <td><strong>Produkt:</strong></td>
                            <td>${wynik.nazwa_produktu}</td>
                        </tr>
                        <tr>
                            <td><strong>Format wydruku:</strong></td>
                            <td>${wynik.format_wydruku_mm[0]}×${wynik.format_wydruku_mm[1]} mm</td>
                        </tr>
                        <tr>
                            <td><strong>Nakład:</strong></td>
                            <td>${wynik.naklad} szt</td>
                        </tr>
                        <tr>
                            <td><strong>Papier:</strong></td>
                            <td>${wynik.rodzaj_papieru} ${wynik.gramatura}g/m²</td>
                        </tr>
                        <tr>
                            <td><strong>Format arkusza:</strong></td>
                            <td>${format.format_name} (${format.szerokosc}×${format.wysokosc} mm, orientacja ${format.orientacja})</td>
                        </tr>
                        <tr>
                            <td><strong>Odpady:</strong></td>
                            <td>${format.odpady_procent.toFixed(1)}%</td>
                        </tr>
                    </table>
                    
                    <hr>
                    
                    <h5>Koszty:</h5>
                    <table class="table table-sm">
                        <tr><td>Papier:</td><td class="text-end">${wynik.koszt_papieru.toFixed(2)} PLN</td></tr>
                        <tr><td>Druk:</td><td class="text-end">${wynik.koszt_druku.toFixed(2)} PLN</td></tr>
                        ${wynik.koszt_czasu_druku && wynik.koszt_czasu_druku > 0 ? `<tr><td class="ps-4"><small>Czas druku:</small></td><td class="text-end"><small>${wynik.koszt_czasu_druku.toFixed(2)} PLN</small></td></tr>` : ''}
                        ${wynik.koszt_ciecia_papieru && wynik.koszt_ciecia_papieru > 0 ? `<tr><td><i class="fas fa-cut"></i> Cięcie papieru z B1:</td><td class="text-end">${wynik.koszt_ciecia_papieru.toFixed(2)} PLN</td></tr>` : ''}
                        ${wynik.koszt_kolorow_spec > 0 ? `<tr><td>Kolory specjalne:</td><td class="text-end">${wynik.koszt_kolorow_spec.toFixed(2)} PLN</td></tr>` : ''}
                        ${wynik.koszt_uszlachetnien > 0 ? `<tr><td>Uszlachetnienia:</td><td class="text-end">${wynik.koszt_uszlachetnien.toFixed(2)} PLN</td></tr>` : ''}
                        ${wynik.koszt_obrobki > 0 ? `<tr><td>Obróbka:</td><td class="text-end">${wynik.koszt_obrobki.toFixed(2)} PLN</td></tr>` : ''}
                        ${wynik.koszt_pakowania > 0 ? `<tr><td>Pakowanie:</td><td class="text-end">${wynik.koszt_pakowania.toFixed(2)} PLN</td></tr>` : ''}
                        ${wynik.koszt_transportu > 0 ? `<tr><td>Transport:</td><td class="text-end">${wynik.koszt_transportu.toFixed(2)} PLN</td></tr>` : ''}
                        <tr class="table-active"><td><strong>Suma kosztów:</strong></td><td class="text-end"><strong>${wynik.suma_kosztow_netto.toFixed(2)} PLN</strong></td></tr>
                        <tr><td>Marża (${wynik.marza_procent}%):</td><td class="text-end">${(wynik.cena_z_marza_netto - wynik.suma_kosztow_netto).toFixed(2)} PLN</td></tr>
                        <tr class="table-active"><td><strong>Cena netto:</strong></td><td class="text-end"><strong>${wynik.cena_z_marza_netto.toFixed(2)} PLN</strong></td></tr>
                        <tr><td>VAT 23%:</td><td class="text-end">${(wynik.cena_brutto_vat23 - wynik.cena_z_marza_netto).toFixed(2)} PLN</td></tr>
                        <tr class="table-success"><td><strong>CENA BRUTTO:</strong></td><td class="text-end"><strong>${wynik.cena_brutto_vat23.toFixed(2)} PLN</strong></td></tr>
                    </table>
                    
                    <hr>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <p><i class="fas fa-clock"></i> <strong>Czas realizacji:</strong> ${wynik.czas_realizacji_h.toFixed(1)} godz</p>
                            ${wynik.czas_druku_h ? `<p class="ms-4 text-muted"><small>Czas druku: ${wynik.czas_druku_h.toFixed(2)} godz</small></p>` : ''}
                        </div>
                        <div class="col-md-6">
                            <p><i class="fas fa-weight"></i> <strong>Waga:</strong> ${wynik.waga_kg.toFixed(2)} kg</p>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Alternatywne formaty
        if (wynik.alternatywne_formaty && wynik.alternatywne_formaty.length > 0) {
            html += `
                <div class="card mt-3">
                    <div class="card-header">Propozycje Alternatywne</div>
                    <div class="card-body">
                        <div class="row">
            `;
            
            wynik.alternatywne_formaty.slice(0, 3).forEach(function(alt, idx) {
                html += `
                    <div class="col-md-4 mb-2">
                        <div class="card">
                            <div class="card-body">
                                <h6>${alt.format_name}</h6>
                                <p class="mb-1"><small>Użytki: ${alt.uzytki_na_ark}</small></p>
                                <p class="mb-1"><small>Wykorzystanie: ${alt.wykorzystanie_procent.toFixed(1)}%</small></p>
                                <p class="mb-0"><small>Koszt papieru: ${alt.koszt_papieru.toFixed(2)} PLN</small></p>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += `
                        </div>
                    </div>
                </div>
            `;
        }
        
        $('#wyniki').html(html).slideDown();
        
        // Scroll do wyników
        $('html, body').animate({
            scrollTop: $('#wyniki').offset().top - 100
        }, 500);
    }

    function wyczyscOferte() {
        blokujAutoCache = true;
        try {
            $('input[name="nazwa_produktu"]').val(defaultFormState.nazwa_produktu);
            $('input[name="naklad"]').val(defaultFormState.naklad);
            $('input[name="format_szerokosc"]').val(defaultFormState.format_szerokosc);
            $('input[name="format_wysokosc"]').val(defaultFormState.format_wysokosc);
            $('#rodzajPracy').val(defaultFormState.rodzaj_pracy || '');

            if (defaultFormState.kategoria_papieru && papieryData[defaultFormState.kategoria_papieru]) {
                $('#kategoriaPapieru').val(defaultFormState.kategoria_papieru);
                const ustawiono = wypelnijRodzajePapieru(
                    defaultFormState.kategoria_papieru,
                    defaultFormState.rodzaj_papieru || ''
                );
                $('#rodzajPapieru').val(defaultFormState.rodzaj_papieru || '');
                if (ustawiono && defaultFormState.rodzaj_papieru) {
                    pobierzGramatury(defaultFormState.rodzaj_papieru, defaultFormState.gramatura || null);
                } else {
                    resetGramaturaSelect();
                }
            } else {
                $('#kategoriaPapieru').val('');
                resetRodzajPapieruSelect();
                resetGramaturaSelect();
            }

            $('#kolorystyka').val(defaultFormState.kolorystyka);
            aktualizujKolorystykeUI(true);
            ustawIloscForm(defaultFormState.ilosc_form || 4, false);

            $('input[name="kolory_specjalne"]').prop('checked', false);
            $('input[name="uszlachetnienia"]').prop('checked', false);
            $('input[name="obrobka"]').prop('checked', false);

            $('[name="pakowanie"]').val(defaultFormState.pakowanie);
            $('[name="transport"]').val(defaultFormState.transport);
            $('[name="marza_procent"]').val(defaultFormState.marza_procent);
            $('[name="priorytet_optymalizacji"]').val(defaultFormState.priorytet_optymalizacji);

            $('#wymagaCiecia').prop('checked', defaultFormState.wymaga_ciecia_papieru);
            $('#odwracankaCheckbox').prop('checked', false);
            odwracankaBazowaLiczbaForm = null;
            aktualizujOdwracankaVisibility();

            ustawKontrahentaZCache(defaultFormState.kontrahent_id || '');

            $('#wyniki').empty().hide();
            $('#loadingSpinner').hide();

            localStorage.removeItem(FORM_CACHE_KEY);
            wyczyscWyborPapieruCache();
        } finally {
            blokujAutoCache = false;
        }
    }

    $('#clearOfferBtn').on('click', function() {
        wyczyscOferte();
    });

    // === AUTOMATYCZNY CACHE FORMULARZA ===

    function zapiszFormularzDoCache() {
        const formData = {
            nazwa_produktu: $('[name="nazwa_produktu"]').val(),
            naklad: $('[name="naklad"]').val(),
            rodzaj_pracy: $('#rodzajPracy').val(),
            format_szerokosc: $('[name="format_szerokosc"]').val(),
            format_wysokosc: $('[name="format_wysokosc"]').val(),
            kategoria_papieru: $('#kategoriaPapieru').val(),
            rodzaj_papieru: $('#rodzajPapieru').val(),
            gramatura: $('#gramatura').val(),
            kolorystyka: $('#kolorystyka').val(),
            ilosc_form: $('#iloscForm').val(),
            pakowanie: $('[name="pakowanie"]').val(),
            transport: $('[name="transport"]').val(),
            marza_procent: $('[name="marza_procent"]').val(),
            priorytet_optymalizacji: $('[name="priorytet_optymalizacji"]').val(),
            kontrahent_id: $('#kontrahent_id').val(),

            kolory_specjalne: $('input[name="kolory_specjalne"]:checked').map(function() { return $(this).val(); }).get(),
            uszlachetnienia: $('input[name="uszlachetnienia"]:checked').map(function() { return $(this).val(); }).get(),
            obrobka: $('input[name="obrobka"]:checked').map(function() { return $(this).val(); }).get(),
            wymaga_ciecia_papieru: $('#wymagaCiecia').is(':checked'),
            odwracanka: $('#odwracankaCheckbox').is(':checked'),
            odwracanka_bazowa_ilosc_form: odwracankaBazowaLiczbaForm
        };

        try {
            localStorage.setItem(FORM_CACHE_KEY, JSON.stringify(formData));
            zapiszWyborPapieruDoCache({
                kategoria: formData.kategoria_papieru || '',
                rodzaj: formData.rodzaj_papieru || '',
                gramatura: formData.gramatura || ''
            });
        } catch (e) {
            console.warn('Nie udało się zapisać cache formularza:', e);
        }
    }

    async function wczytajFormularzZCache() {
        const cachedData = localStorage.getItem(FORM_CACHE_KEY);
        if (!cachedData) return;

        blokujAutoCache = true;
        try {
            const formData = JSON.parse(cachedData) || {};

            if (formData.nazwa_produktu !== undefined) $('[name="nazwa_produktu"]').val(formData.nazwa_produktu);
            if (formData.naklad !== undefined) $('[name="naklad"]').val(formData.naklad);
            if (formData.rodzaj_pracy !== undefined) $('#rodzajPracy').val(formData.rodzaj_pracy);
            if (formData.format_szerokosc !== undefined) $('[name="format_szerokosc"]').val(formData.format_szerokosc);
            if (formData.format_wysokosc !== undefined) $('[name="format_wysokosc"]').val(formData.format_wysokosc);

            const papierDoPrzywrocenia = {
                kategoria: formData.kategoria_papieru || '',
                rodzaj: formData.rodzaj_papieru || '',
                gramatura: formData.gramatura || ''
            };

            if (papierDoPrzywrocenia.kategoria || papierDoPrzywrocenia.rodzaj || papierDoPrzywrocenia.gramatura) {
                zapiszWyborPapieruDoCache(papierDoPrzywrocenia);
            }

            const przywroconoPapier = await przywrocPapierZFormularza(
                papierDoPrzywrocenia.kategoria,
                papierDoPrzywrocenia.rodzaj,
                papierDoPrzywrocenia.gramatura
            );

            if (!przywroconoPapier && papierDoPrzywrocenia.kategoria) {
                oczekujacyPapierDoPrzywrocenia = papierDoPrzywrocenia;
                sprobujPrzywrocicPapierJesliOczekuje();
            }

            if (formData.ilosc_form) {
                ustawIloscForm(formData.ilosc_form, false);
            }

            if (formData.kolorystyka) {
                $('#kolorystyka').val(formData.kolorystyka);
            }
            aktualizujKolorystykeUI(false);

            if (formData.pakowanie !== undefined) $('[name="pakowanie"]').val(formData.pakowanie);
            if (formData.transport !== undefined) $('[name="transport"]').val(formData.transport);
            if (formData.marza_procent !== undefined) $('[name="marza_procent"]').val(formData.marza_procent);
            if (formData.priorytet_optymalizacji !== undefined) $('[name="priorytet_optymalizacji"]').val(formData.priorytet_optymalizacji);

            if (formData.kontrahent_id !== undefined) {
                const ustawionoKontrahenta = ustawKontrahentaZCache(formData.kontrahent_id);
                if (!ustawionoKontrahenta) {
                    oczekujacyKontrahentId = (formData.kontrahent_id !== null && formData.kontrahent_id !== '')
                        ? String(formData.kontrahent_id)
                        : null;
                }
            } else {
                ustawKontrahentaZCache('');
            }

            $('input[name="kolory_specjalne"]').prop('checked', false);
            (formData.kolory_specjalne || []).forEach(function(val) {
                $('input[name="kolory_specjalne"][value="' + val + '"]').prop('checked', true);
            });

            $('input[name="uszlachetnienia"]').prop('checked', false);
            (formData.uszlachetnienia || []).forEach(function(val) {
                $('input[name="uszlachetnienia"][value="' + val + '"]').prop('checked', true);
            });

            $('input[name="obrobka"]').prop('checked', false);
            (formData.obrobka || []).forEach(function(val) {
                $('input[name="obrobka"][value="' + val + '"]').prop('checked', true);
            });

            if (formData.wymaga_ciecia_papieru !== undefined) {
                $('#wymagaCiecia').prop('checked', formData.wymaga_ciecia_papieru);
            }

            if (formData.odwracanka_bazowa_ilosc_form) {
                odwracankaBazowaLiczbaForm = formData.odwracanka_bazowa_ilosc_form;
            }
            $('#odwracankaCheckbox').prop('checked', !!formData.odwracanka);
            aktualizujOdwracankaVisibility();

            console.log('Formularz wczytany z cache');
        } catch (e) {
            console.error('Błąd wczytywania cache formularza:', e);
        } finally {
            blokujAutoCache = false;
        }
    }

    // Wczytaj cache przy starcie po załadowaniu papierów
    papieryPromise.then(() => wczytajFormularzZCache());

    // Zapisuj przy każdej zmianie
    $('#kalkulatorForm input, #kalkulatorForm select').on('change input', function() {
        if (blokujAutoCache) return;
        zapiszFormularzDoCache();
    });

    $('a').on('click', function() {
        if (blokujAutoCache) return;
        zapiszFormularzDoCache();
    });

    $(document).on('visibilitychange', function() {
        if (document.visibilityState === 'hidden' && !blokujAutoCache) {
            zapiszFormularzDoCache();
        }
    });

    $(window).on('beforeunload', function() {
        if (!blokujAutoCache) {
            zapiszFormularzDoCache();
        }
    });

    // Opcjonalnie: wyczyść cache po udanej kalkulacji (wyłączone - zachowujemy dane)
    // $('#kalkulatorForm').on('submit', function() {
    //     setTimeout(function() {
    //         localStorage.removeItem(FORM_CACHE_KEY);
    //     }, 1000);
    // });
});
</script>
{% endblock %}
