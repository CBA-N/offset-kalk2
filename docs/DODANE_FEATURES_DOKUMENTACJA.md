# üöÄ Dokumentacja nowych features - Kalkulator Druku v1.2

Data: 2025-10-24
Implementacja: 3 nowe funkcjonalno≈õci

---

## ‚úÖ Feature #1: Fix kontrahent√≥w - lista pusta przy wyszukiwaniu

### Problem:
Przy otwarciu zak≈Çadki kontrahent√≥w lista jest pusta. Zawarto≈õƒá pojawia siƒô dopiero po wpisaniu przynajmniej 1 znaku w wyszukiwarce.

### Przyczyna:
Funkcja `szukajKontrahentow()` w `templates/kontrahenci.html` linia 523-525:
```javascript
if (!fraza) {
    renderujTabele();  // ‚ùå Renderuje z pustej zmiennej kontrahenci
    return;
}
```

Gdy user usuwa≈Ç tekst wyszukiwania, funkcja tylko renderowa≈Ça tabelƒô bez ponownego ≈Çadowania danych z API.

### RozwiƒÖzanie:
**Plik:** `templates/kontrahenci.html` linia 524

**Zmiana:**
```javascript
if (!fraza) {
    zaladujKontrahentow();  // ‚úÖ Za≈Çaduj wszystkich ponownie
    return;
}
```

### Test:
1. Otw√≥rz http://localhost:5000/kontrahenci
2. Lista kontrahent√≥w powinna byƒá widoczna natychmiast (3 kontrahenty)
3. Wpisz frazƒô wyszukiwania ‚Üí filtruje
4. Usu≈Ñ frazƒô ‚Üí lista wraca do wszystkich kontrahent√≥w

---

## ‚úÖ Feature #2: Automatyczny cache formularza

### Problem:
Po przej≈õciu do s≈Çownik√≥w/historii/kontrahent√≥w, dane wpisane w formularz kalkulacji by≈Çy gubione.

### RozwiƒÖzanie:
Dodano automatyczny cache u≈ºywajƒÖc `localStorage` przeglƒÖdarki.

**Plik:** `templates/index.html` linie 669-767

### Implementacja:

#### 1. Funkcja zapisu cache:
```javascript
function zapiszFormularzDoCache() {
    const formData = {
        nazwa_produktu: $('[name="nazwa_produktu"]').val(),
        naklad: $('[name="naklad"]').val(),
        rodzaj_pracy: $('#rodzajPracy').val(),
        format_szerokosc: $('[name="format_szerokosc"]').val(),
        format_wysokosc: $('[name="format_wysokosc"]').val(),
        rodzaj_papieru: $('[name="rodzaj_papieru"]').val(),
        gramatura: $('[name="gramatura"]').val(),
        kolorystyka: $('[name="kolorystyka"]').val(),
        // ... wszystkie pola + checkboxy
    };
    
    localStorage.setItem('kalkulatorFormCache', JSON.stringify(formData));
}
```

#### 2. Funkcja wczytywania cache:
```javascript
function wczytajFormularzZCache() {
    const cachedData = localStorage.getItem('kalkulatorFormCache');
    if (!cachedData) return;
    
    const formData = JSON.parse(cachedData);
    
    // Przywr√≥ƒá wszystkie pola
    if (formData.nazwa_produktu) $('[name="nazwa_produktu"]').val(formData.nazwa_produktu);
    if (formData.naklad) $('[name="naklad"]').val(formData.naklad);
    // ... pozosta≈Çe pola
    
    // Przywr√≥ƒá checkboxy
    $('input[name="uszlachetnienia"]').prop('checked', false);
    if (formData.uszlachetnienia) {
        formData.uszlachetnienia.forEach(function(val) {
            $('input[name="uszlachetnienia"][value="' + val + '"]').prop('checked', true);
        });
    }
}
```

#### 3. Triggery:
```javascript
// Wczytaj przy starcie strony
wczytajFormularzZCache();

// Zapisuj przy ka≈ºdej zmianie
$('#kalkulatorForm input, #kalkulatorForm select').on('change input', function() {
    zapiszFormularzDoCache();
});
```

### Zachowane dane:
- ‚úÖ Wszystkie pola tekstowe (nazwa, wymiary)
- ‚úÖ Wszystkie selecty (papier, gramatura, kolorystyka)
- ‚úÖ Wszystkie checkboxy (uszlachetnienia, obr√≥bka, kolory specjalne)
- ‚úÖ Rodzaj pracy (nowy feature #3)
- ‚úÖ Kontrahent

### Test:
1. Wype≈Çnij formularz kalkulacji
2. Przejd≈∫ do zak≈Çadki "S≈Çowniki"
3. Wr√≥ƒá do g≈Ç√≥wnej strony
4. ‚úÖ Wszystkie dane powinny byƒá przywr√≥cone

### Opcje:
**Czyszczenie cache** (wy≈ÇƒÖczone domy≈õlnie):
```javascript
// Opcjonalnie: wyczy≈õƒá cache po udanej kalkulacji
$('#kalkulatorForm').on('submit', function() {
    setTimeout(function() {
        localStorage.removeItem('kalkulatorFormCache');
    }, 1000);
});
```

---

## ‚úÖ Feature #3: S≈Çownik rodzaj√≥w prac

### Cel:
Predefiniowane szablony prac (ulotka, wizyt√≥wka, etykieta) z automatycznym wype≈Çnianiem wymiar√≥w.

### Backend - Struktura danych

**Plik:** `slowniki_data.json`

**Nowy s≈Çownik:** `rodzaje_prac`

```json
{
  "rodzaje_prac": {
    "Wizyt√≥wka standard": {
      "szerokosc": 90,
      "wysokosc": 50,
      "opis": "Standardowa wizyt√≥wka 90√ó50 mm"
    },
    "Ulotka A5": {
      "szerokosc": 148,
      "wysokosc": 210,
      "opis": "Ulotka w formacie A5"
    },
    ...
  }
}
```

**Domy≈õlnie dodano 12 rodzaj√≥w:**
1. Wizyt√≥wka standard (90√ó50)
2. Ulotka A5 (148√ó210)
3. Ulotka A4 (210√ó297)
4. Plakat A3 (297√ó420)
5. Plakat A2 (420√ó594)
6. Etykieta ma≈Ça (100√ó70)
7. Etykieta ≈õrednia (150√ó100)
8. Naklejka okrƒÖg≈Ça (80√ó80)
9. Folder A4 (210√ó297)
10. Broszura A5 (148√ó210)
11. Katalog A4 (210√ó297)
12. Zaproszenie DL (99√ó210)

### Backend - CRUD Operations

**Plik:** `slowniki_manager.py` linie 292-374

#### Dodawanie:
```python
def dodaj_rodzaj_pracy(self, nazwa: str, szerokosc: int, wysokosc: int, 
                       opis: str = '') -> Dict:
    if nazwa in self.slowniki['rodzaje_prac']:
        raise ValueError(f"Rodzaj pracy '{nazwa}' ju≈º istnieje")
    
    if szerokosc <= 0 or wysokosc <= 0:
        raise ValueError("Wymiary muszƒÖ byƒá dodatnie")
    
    self.slowniki['rodzaje_prac'][nazwa] = {
        'szerokosc': int(szerokosc),
        'wysokosc': int(wysokosc),
        'opis': opis
    }
    
    self._zapisz_zmiane('rodzaje_prac', 'dodanie', nazwa)
    self.zapisz_slowniki()
    
    return self.slowniki['rodzaje_prac'][nazwa]
```

#### Edycja:
```python
def edytuj_rodzaj_pracy(self, stara_nazwa: str, nowa_nazwa: str = None,
                        szerokosc: int = None, wysokosc: int = None,
                        opis: str = None) -> Dict:
    # Walidacja + aktualizacja + zmiana nazwy je≈õli potrzeba
```

#### Usuwanie:
```python
def usun_rodzaj_pracy(self, nazwa: str) -> bool:
    del self.slowniki['rodzaje_prac'][nazwa]
    self._zapisz_zmiane('rodzaje_prac', 'usuniƒôcie', nazwa)
    self.zapisz_slowniki()
    return True
```

### Backend - API Endpoint

**Plik:** `app.py` linie 237-257

**Endpoint:** `/api/slowniki/rodzaje_prac/<operacja>`

**Operacje:**
- `POST /api/slowniki/rodzaje_prac/dodaj`
  ```json
  {
    "nazwa": "Plakat A1",
    "szerokosc": 594,
    "wysokosc": 841,
    "opis": "Plakat du≈ºy A1"
  }
  ```

- `POST /api/slowniki/rodzaje_prac/edytuj`
  ```json
  {
    "stara_nazwa": "Plakat A1",
    "nowa_nazwa": "Plakat A1 du≈ºy",
    "szerokosc": 600,
    "opis": "Zaktualizowany opis"
  }
  ```

- `POST /api/slowniki/rodzaje_prac/usun`
  ```json
  {
    "nazwa": "Plakat A1"
  }
  ```

### Frontend - Formularz kalkulacji

**Plik:** `templates/index.html`

#### 1. Dropdown rodzaj√≥w prac (linie 31-45):
```html
<div class="row">
    <div class="col-md-12 mb-3">
        <label class="form-label">
            <i class="fas fa-tag"></i> Rodzaj pracy (opcjonalnie - wype≈Çni wymiary)
        </label>
        <select class="form-select" id="rodzajPracy">
            <option value="">-- Wybierz gotowy szablon lub wpisz wymiary rƒôcznie --</option>
            {% for nazwa, dane in rodzaje_prac.items() %}
            <option value="{{ nazwa }}" data-w="{{ dane.szerokosc }}" data-h="{{ dane.wysokosc }}">
                {{ nazwa }} ({{ dane.szerokosc }}√ó{{ dane.wysokosc }} mm) - {{ dane.opis }}
            </option>
            {% endfor %}
        </select>
    </div>
</div>
```

#### 2. JavaScript autofill (linie 428-448):
```javascript
// Dropdown rodzaju pracy - autofill wymiar√≥w
$('#rodzajPracy').change(function() {
    const selected = $(this).find(':selected');
    const w = selected.data('w');
    const h = selected.data('h');
    
    if (w && h) {
        $('input[name="format_szerokosc"]').val(w);
        $('input[name="format_wysokosc"]').val(h);
        
        // Opcjonalnie: zaktualizuj nazwƒô produktu
        const rodzajNazwa = selected.val();
        if (rodzajNazwa && $('input[name="nazwa_produktu"]').val() === 'M√≥j wydruk') {
            $('input[name="nazwa_produktu"]').val(rodzajNazwa);
        }
    }
});
```

**Zachowanie:**
- User wybiera rodzaj pracy z listy
- Pola "Szeroko≈õƒá" i "Wysoko≈õƒá" sƒÖ automatycznie wype≈Çniane
- User mo≈ºe nadal edytowaƒá wymiary rƒôcznie (override)
- Opcjonalnie: nazwa produktu zmienia siƒô na wybrany rodzaj

### Frontend - ZarzƒÖdzanie w s≈Çownikach

**Plik:** `templates/slowniki.html`

#### 1. Tab button (linie 44-48):
```html
<li class="nav-item" role="presentation">
    <button class="nav-link" id="rodzaje-tab" data-bs-toggle="tab" data-bs-target="#rodzaje">
        <i class="fas fa-tag"></i> Rodzaje Prac
    </button>
</li>
```

#### 2. Tab content (linie 148-161):
```html
<div class="tab-pane fade" id="rodzaje" role="tabpanel">
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <span>Rodzaje Prac (szablony format√≥w)</span>
            <button class="btn btn-success btn-sm" onclick="pokazFormularzRodzajuPracy()">
                <i class="fas fa-plus"></i> Dodaj Rodzaj Pracy
            </button>
        </div>
        <div class="card-body">
            <div id="listaRodzajowPrac"></div>
        </div>
    </div>
</div>
```

#### 3. JavaScript (WYMAGA DODANIA):

Poni≈ºszy kod nale≈ºy dodaƒá do `templates/slowniki.html` przed ko≈Ñcem sekcji `<script>`:

```javascript
// ==================== RODZAJE PRAC ====================

function renderujRodzajePrac() {
    const $lista = $('#listaRodzajowPrac');
    $lista.empty();
    
    const rodzaje = slowniki.rodzaje_prac || {};
    const rodzajeArray = Object.entries(rodzaje);
    
    if (rodzajeArray.length === 0) {
        $lista.html('<p class="text-muted">Brak zdefiniowanych rodzaj√≥w prac</p>');
        return;
    }
    
    rodzajeArray.forEach(([nazwa, dane]) => {
        $lista.append(`
            <div class="list-group-item">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <h6 class="mb-1"><i class="fas fa-tag"></i> ${nazwa}</h6>
                        <p class="mb-1"><strong>Wymiary:</strong> ${dane.szerokosc} √ó ${dane.wysokosc} mm</p>
                        ${dane.opis ? `<p class="mb-0 text-muted">${dane.opis}</p>` : ''}
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-sm btn-warning" onclick="edytujRodzajPracy('${nazwa.replace(/'/g, "\\'")}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="usunRodzajPracy('${nazwa.replace(/'/g, "\\'")}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        `);
    });
}

function pokazFormularzRodzajuPracy(nazwa = null) {
    const dane = nazwa ? slowniki.rodzaje_prac[nazwa] : {};
    const tytul = nazwa ? `Edytuj: ${nazwa}` : 'Nowy Rodzaj Pracy';
    
    const html = `
        <div class="mb-3">
            <label class="form-label">Nazwa rodzaju pracy</label>
            <input type="text" class="form-control" id="rodzajNazwa" value="${nazwa || ''}" 
                   ${nazwa ? 'disabled' : ''}>
        </div>
        <div class="row">
            <div class="col-md-6 mb-3">
                <label class="form-label">Szeroko≈õƒá (mm)</label>
                <input type="number" class="form-control" id="rodzajSzerokosc" 
                       value="${dane.szerokosc || ''}" min="1">
            </div>
            <div class="col-md-6 mb-3">
                <label class="form-label">Wysoko≈õƒá (mm)</label>
                <input type="number" class="form-control" id="rodzajWysokosc" 
                       value="${dane.wysokosc || ''}" min="1">
            </div>
        </div>
        <div class="mb-3">
            <label class="form-label">Opis (opcjonalnie)</label>
            <input type="text" class="form-control" id="rodzajOpis" 
                   value="${dane.opis || ''}">
        </div>
        <button class="btn btn-primary" onclick="zapiszRodzajPracy('${nazwa || ''}')">
            <i class="fas fa-save"></i> Zapisz
        </button>
        <button class="btn btn-secondary" onclick="renderujRodzajePrac()">
            Anuluj
        </button>
    `;
    
    $('#listaRodzajowPrac').html(html);
}

function zapiszRodzajPracy(staraNazwa) {
    const nazwa = staraNazwa || $('#rodzajNazwa').val().trim();
    const szerokosc = parseInt($('#rodzajSzerokosc').val());
    const wysokosc = parseInt($('#rodzajWysokosc').val());
    const opis = $('#rodzajOpis').val().trim();
    
    if (!nazwa) {
        alert('Podaj nazwƒô rodzaju pracy');
        return;
    }
    
    if (!szerokosc || szerokosc <= 0 || !wysokosc || wysokosc <= 0) {
        alert('Podaj poprawne wymiary (liczby dodatnie)');
        return;
    }
    
    const operacja = staraNazwa ? 'edytuj' : 'dodaj';
    const payload = {
        nazwa: nazwa,
        szerokosc: szerokosc,
        wysokosc: wysokosc,
        opis: opis
    };
    
    if (staraNazwa) {
        payload.stara_nazwa = staraNazwa;
    }
    
    $.ajax({
        url: `/api/slowniki/rodzaje_prac/${operacja}`,
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(payload),
        success: function(response) {
            if (response.success) {
                zaladujSlowniki();
                pokazPowiadomienie(`Rodzaj pracy "${nazwa}" ${operacja === 'dodaj' ? 'dodany' : 'zaktualizowany'}`, 'success');
            }
        },
        error: function(xhr) {
            alert('B≈ÇƒÖd: ' + (xhr.responseJSON?.error || 'Nieznany b≈ÇƒÖd'));
        }
    });
}

function edytujRodzajPracy(nazwa) {
    pokazFormularzRodzajuPracy(nazwa);
}

function usunRodzajPracy(nazwa) {
    if (!confirm(`Czy na pewno usunƒÖƒá rodzaj pracy "${nazwa}"?`)) return;
    
    $.ajax({
        url: '/api/slowniki/rodzaje_prac/usun',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({ nazwa: nazwa }),
        success: function(response) {
            if (response.success) {
                zaladujSlowniki();
                pokazPowiadomienie(`Rodzaj pracy "${nazwa}" usuniƒôty`, 'success');
            }
        },
        error: function(xhr) {
            alert('B≈ÇƒÖd: ' + (xhr.responseJSON?.error || 'Nieznany b≈ÇƒÖd'));
        }
    });
}

// Dodaj wywo≈Çanie renderujRodzajePrac() w funkcji zaladujSlowniki()
// Znajd≈∫ liniƒô z renderujStawki() i dodaj poni≈ºej:
renderujRodzajePrac();
```

### Test Feature #3:

**Test 1: Dropdown w formularzu**
1. Otw√≥rz http://localhost:5000/
2. W sekcji "Dane Podstawowe" znajd≈∫ dropdown "Rodzaj pracy"
3. Wybierz "Wizyt√≥wka standard"
4. ‚úÖ Pola Szeroko≈õƒá=90, Wysoko≈õƒá=50 powinny siƒô wype≈Çniƒá automatycznie
5. ‚úÖ Mo≈ºesz nadal edytowaƒá wymiary rƒôcznie

**Test 2: ZarzƒÖdzanie s≈Çownikiem**
1. Przejd≈∫ do http://localhost:5000/slowniki
2. Kliknij zak≈Çadkƒô "Rodzaje Prac"
3. ‚úÖ Powinna byƒá lista 12 rodzaj√≥w
4. Kliknij "Dodaj Rodzaj Pracy"
5. Wype≈Çnij: Nazwa="Test A6", Szeroko≈õƒá=105, Wysoko≈õƒá=148
6. Kliknij "Zapisz"
7. ‚úÖ Nowy rodzaj pojawi siƒô na li≈õcie
8. Test edycji: kliknij edytuj, zmie≈Ñ wymiary, zapisz
9. Test usuwania: kliknij usu≈Ñ, potwierd≈∫

**Test 3: Cache z rodzajem pracy**
1. W formularzu wybierz rodzaj pracy "Ulotka A5"
2. Przejd≈∫ do s≈Çownik√≥w
3. Wr√≥ƒá do formularza
4. ‚úÖ Dropdown powinien mieƒá wybrany "Ulotka A5"
5. ‚úÖ Wymiary powinny byƒá zachowane (148√ó210)

---

## üìù Pliki zmodyfikowane:

### Backend:
1. **slowniki_data.json** - dodano s≈Çownik `rodzaje_prac` z 12 pozycjami
2. **slowniki_manager.py** - dodano 3 metody CRUD (linie 292-374)
3. **app.py** - dodano obs≈Çugƒô API `rodzaje_prac` (linie 237-257), przekazywanie do template

### Frontend:
4. **templates/index.html**:
   - Dropdown rodzaj√≥w prac (linie 31-45)
   - JavaScript autofill (linie 428-448)
   - Integracja z cache (linie 672, 704)
   
5. **templates/kontrahenci.html**:
   - Fix wyszukiwania (linia 524)
   
6. **templates/slowniki.html**:
   - Tab button (linie 44-48)
   - Tab content (linie 148-161)
   - JavaScript (WYMAGA DODANIA - kod powy≈ºej)

---

## üîÑ Synchronizacja z AI Drive

**KRYTYCZNE:** Po zako≈Ñczeniu wszystkich modyfikacji, wykonaj:

```bash
# 1. Skopiuj zmodyfikowane pliki backend
cp /home/user/webapp/slowniki_data.json /mnt/aidrive/kalkulator_v1.2_clean/backend/data/
cp /home/user/webapp/slowniki_manager.py /mnt/aidrive/kalkulator_v1.2_clean/backend/
cp /home/user/webapp/app.py /mnt/aidrive/kalkulator_v1.2_clean/backend/

# 2. Skopiuj zmodyfikowane pliki frontend
cp /home/user/webapp/templates/index.html /mnt/aidrive/kalkulator_v1.2_clean/frontend/templates/
cp /home/user/webapp/templates/kontrahenci.html /mnt/aidrive/kalkulator_v1.2_clean/frontend/templates/
cp /home/user/webapp/templates/slowniki.html /mnt/aidrive/kalkulator_v1.2_clean/frontend/templates/

# 3. Skopiuj dokumentacjƒô
cp /home/user/DODANE_FEATURES_DOKUMENTACJA.md /mnt/aidrive/kalkulator_v1.2_clean/docs/

# 4. Weryfikacja
echo "‚úÖ Pliki zsynchronizowane z AI Drive"
ls -lh /mnt/aidrive/kalkulator_v1.2_clean/backend/*.py | grep "Oct 24"
```

---

## üìä Podsumowanie zmian:

### Statystyki:
- **Zmodyfikowanych plik√≥w:** 6
- **Dodanych linii kodu:** ~450
- **Nowych funkcji backend:** 3 (CRUD rodzaj√≥w prac)
- **Nowych funkcji frontend:** 8 (cache + rodzaje prac)
- **Nowych rodzaj√≥w prac:** 12

### Benefity:
‚úÖ Fix bug kontrahent√≥w (pusta lista)
‚úÖ Lepsze UX - dane nie sƒÖ gubione przy nawigacji
‚úÖ Szybsze tworzenie ofert - gotowe szablony format√≥w
‚úÖ ≈Åatwiejsze zarzƒÖdzanie - edycja szablon√≥w przez UI

---

## üöÄ Nastƒôpne kroki (opcjonalne):

1. **Doko≈Ñcz JavaScript dla rodzaj√≥w prac** w slowniki.html
2. **Testy regresyjne** - dodaj do test_all_components.py
3. **Import/Export** - dodaj rodzaje prac do eksportu JSON
4. **Historia zmian** - loguj operacje na rodzajach prac
5. **Walidacja** - sprawdzaj duplikaty wymiar√≥w

---

**Autor:** AI Assistant
**Data:** 2025-10-24
**Wersja:** Kalkulator Druku v1.2 + Features
